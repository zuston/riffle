version: "3"

networks:
  riffle-network:
    driver: bridge

x-common-volumes: &common-volumes
  - ~/.cargo/git:/root/.cargo/git:rw
  - ~/.cargo/registry:/root/.cargo/registry:rw
  - ./../../:/riffle:rw
  - ./../../target-docker:/riffle/target:rw

services:
  # Uniffle Coordinator 
  uniffle-coordinator:
    build:
      context: .
    container_name: uniffle-coordinator
    hostname: coordinator
    networks:
      - riffle-network
    ports:
      - "19995:19995"  # Web UI
      - "21000:21000"  # RPC
    volumes: *common-volumes
    command: coordinator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19995/api/app/total"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Riffle Server 1 
  riffle-server-1:
    build:
      context: .
    container_name: riffle-server-1
    hostname: riffle-server-1
    networks:
      - riffle-network
    ports:
      - "19998:19998"  # HTTP port
      - "21100:21100"  # gRPC port
    volumes: *common-volumes
    command: riffle-server-1
    depends_on:
      uniffle-coordinator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19998/metrics"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Riffle Server 2 
  riffle-server-2:
    build:
      context: .
    container_name: riffle-server-2
    hostname: riffle-server-2
    networks:
      - riffle-network
    ports:
      - "19999:19999"  # HTTP port
      - "21101:21101"  # gRPC port
    volumes: *common-volumes
    command: riffle-server-2
    depends_on:
      uniffle-coordinator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19999/metrics"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Spark Client 
  spark-client:
    build:
      context: .
    container_name: spark-client
    hostname: spark-client
    stdin_open: true
    tty: true
    networks:
      - riffle-network
    ports:
      - "4040:4040"  # Spark UI
    volumes: *common-volumes
    command: spark-client
    depends_on:
      riffle-server-1:
        condition: service_healthy
      riffle-server-2:
        condition: service_healthy
    environment:
      - COORDINATOR_HOST=coordinator
      - RIFFLE_SERVER_1_HOST=riffle-server-1
      - RIFFLE_SERVER_2_HOST=riffle-server-2

  # run all tests
  riffle-test:
    build:
      context: .
    container_name: riffle-test
    networks:
      - riffle-network
    volumes: *common-volumes
    command: run-tests
    depends_on:
      riffle-server-1:
        condition: service_healthy
      riffle-server-2:
        condition: service_healthy
    environment:
      - COORDINATOR_HOST=coordinator
      - RIFFLE_SERVER_1_HOST=riffle-server-1
      - RIFFLE_SERVER_2_HOST=riffle-server-2
    profiles:
      - test
